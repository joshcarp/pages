name: Deploy to GitHub Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Prepare site artifact
        run: |
          mkdir -p _site
          rsync -av --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude ".gitignore" \
            --exclude "_site" \
            --exclude "node_modules" \
            ./ _site/
          # Set custom domain
          echo "pages.joshcarp.com" > _site/CNAME
          # Generate an index.html that lists all directories
          mapfile -t DIRS < <(find _site -mindepth 1 -type d -print | sed 's#^_site/##' | sort)
          {
            echo "<!doctype html>";
            echo "<html lang=\"en\">";
            echo "<head>";
            echo "  <meta charset=\"utf-8\">";
            echo "  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">";
            echo "  <title>Index of directories</title>";
            echo "  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;max-width:800px;margin:40px auto;padding:0 16px}h1{font-size:1.5rem}ul{line-height:1.8}code{background:#f6f8fa;padding:.1rem .3rem;border-radius:4px}</style>";
            echo "</head>";
            echo "<body>";
            echo "  <h1>Index of directories</h1>";
            echo "  <ul>";
            if [ ${#DIRS[@]} -eq 0 ]; then
              echo "    <li><em>No directories found</em></li>";
            else
              for d in "${DIRS[@]}"; do
                safe_label=$(printf '%s' "$d" | sed 's/&/&amp;/g; s/</&lt;/g; s/>/&gt;/g')
                echo "    <li><a href=\"$d/\">$safe_label/</a></li>";
              done
            fi
            echo "  </ul>";
            echo "</body>";
            echo "</html>";
          } > _site/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          cname: pages.joshcarp.com


